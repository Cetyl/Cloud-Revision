# EKS IRSA Cross-Account S3 Access ‚Äì Final Setup Guide

## üéØ Goal

Allow pods in an Amazon EKS cluster in **Account A** to securely access **S3 buckets in Account B** using **IAM Roles for Service Accounts (IRSA)** and **STS cross-account role assumption** ‚Äî *without static credentials*.

---

## üß© Architecture Overview

```text
Pod (in EKS - Account A)
  ‚Üì uses
ServiceAccount (IRSA)
  ‚Üì assumes
IAM Role in Account A (App1IRSA-S3Role)
  ‚Üì assumes
IAM Role in Account B (AccountB-S3AccessRole)
  ‚Üì accesses
S3 Bucket in Account B (app1-bucket-irsa)
````

---

## ü™£ Prerequisites

* AWS CLI configured (use AWS CloudShell or local AWS CLI)
* EKS cluster running in Account A
* Access to both AWS accounts
* `kubectl` access to the EKS cluster

---

## ‚öôÔ∏è Step-by-Step Setup

### Step 1: Enable OIDC Provider for Your EKS Cluster (Account A)

In **CloudShell (Account A)**:

```bash
aws eks describe-cluster --name <EKS_CLUSTER_NAME> --query "cluster.identity.oidc.issuer" --output text
```

Copy the OIDC URL.

Then associate the OIDC provider:

```bash
eksctl utils associate-iam-oidc-provider \
  --region <region> \
  --cluster <EKS_CLUSTER_NAME> \
  --approve
```

---

### Step 2: Create IAM Role for IRSA in Account A

#### 2.1 Trust Policy (`App1IRSA-S3Role-trust.json`)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::<ACCOUNT_A_ID>:oidc-provider/oidc.eks.<region>.amazonaws.com/id/<OIDC_ID>"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "oidc.eks.<region>.amazonaws.com/id/<OIDC_ID>:sub": "system:serviceaccount:app1-ns:app1-sa"
        }
      }
    }
  ]
}
```

#### 2.2 Create Role

```bash
aws iam create-role \
  --role-name App1IRSA-S3Role \
  --assume-role-policy-document file://App1IRSA-S3Role-trust.json
```

#### 2.3 Attach Policy to Allow Cross-Account Assume Role

```bash
aws iam put-role-policy \
  --role-name App1IRSA-S3Role \
  --policy-name AllowAssumeAccountBRole \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "sts:AssumeRole",
        "Resource": "arn:aws:iam::<ACCOUNT_B_ID>:role/AccountB-S3AccessRole"
      }
    ]
  }'
```

---

### Step 3: Create IAM Role in Account B

#### 3.1 Trust Policy (`AccountB-S3AccessRole-trust.json`)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::<ACCOUNT_A_ID>:role/App1IRSA-S3Role"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

#### 3.2 Create Role

```bash
aws iam create-role \
  --role-name AccountB-S3AccessRole \
  --assume-role-policy-document file://AccountB-S3AccessRole-trust.json
```

#### 3.3 Attach S3 Permissions

```bash
aws iam put-role-policy \
  --role-name AccountB-S3AccessRole \
  --policy-name S3AccessPolicy \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": ["s3:ListBucket"],
        "Resource": ["arn:aws:s3:::app1-bucket-irsa"]
      },
      {
        "Effect": "Allow",
        "Action": ["s3:GetObject", "s3:PutObject"],
        "Resource": ["arn:aws:s3:::app1-bucket-irsa/*"]
      }
    ]
  }'
```

---

### Step 4: Update S3 Bucket Policy (Account B)

Navigate to the **S3 bucket > Permissions > Bucket Policy** and add:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::<ACCOUNT_B_ID>:role/AccountB-S3AccessRole"
      },
      "Action": ["s3:ListBucket", "s3:GetObject", "s3:PutObject"],
      "Resource": [
        "arn:aws:s3:::app1-bucket-irsa",
        "arn:aws:s3:::app1-bucket-irsa/*"
      ]
    }
  ]
}
```

---

### Step 5: Configure Kubernetes in Account A

#### 5.1 Create Namespace and Service Account

```yaml
# app1-sa.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: app1-ns
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app1-sa
  namespace: app1-ns
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::<ACCOUNT_A_ID>:role/App1IRSA-S3Role
```

```bash
kubectl apply -f app1-sa.yaml
```

---

### Step 6: Create the Pod Deployment

```yaml
# app1-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app1-deployment
  namespace: app1-ns
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app1
  template:
    metadata:
      labels:
        app: app1
    spec:
      serviceAccountName: app1-sa
      containers:
      - name: aws-cli
        image: amazon/aws-cli
        command: ["/bin/sh", "-c"]
        args:
          - >
            echo "Assuming cross-account role...";
            CREDS=$(aws sts assume-role --role-arn arn:aws:iam::<ACCOUNT_B_ID>:role/AccountB-S3AccessRole --role-session-name crossaccttest);
            export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r .Credentials.AccessKeyId);
            export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r .Credentials.SecretAccessKey);
            export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r .Credentials.SessionToken);
            echo "Caller identity after assume-role:";
            aws sts get-caller-identity;
            echo "Listing objects in Account B bucket:";
            aws s3 ls s3://app1-bucket-irsa;
            sleep 3600
```

```bash
kubectl apply -f app1-deployment.yaml
```

---

### Step 7: Validate

Check the pod logs:

```bash
kubectl get pods -n app1-ns
kubectl logs -f <pod-name> -n app1-ns
```

Expected output:

```json
Caller identity after assume-role:
{
  "Account": "<ACCOUNT_B_ID>",
  "Arn": "arn:aws:sts::<ACCOUNT_B_ID>:assumed-role/AccountB-S3AccessRole/..."
}
```

```text
Listing objects in Account B bucket:
                           PRE test/
```

---

## ‚úÖ Summary of Trust Chain

| Layer          | Entity                | Trusts / Permissions                                        |
| -------------- | --------------------- | ----------------------------------------------------------- |
| OIDC           | EKS OIDC Provider     | Trusted by Account A role                                   |
| Account A Role | App1IRSA-S3Role       | Trusted by OIDC provider + allowed to assume Account B role |
| Account B Role | AccountB-S3AccessRole | Trusted by Account A role                                   |
| S3 Bucket      | app1-bucket-irsa      | Allows Account B role actions                               |

---

## üß† Security Highlights

* üîê No static credentials in pods
* ‚è±Ô∏è Short-lived tokens (automatically rotated)
* üéØ Scoped trust (namespace + service account restricted)
* üìú Auditable via CloudTrail (assume-role and S3 actions)
* üß© Easily extensible for multiple deployments or buckets






